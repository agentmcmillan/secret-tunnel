# Secret Tunnel - VPN On Demand

VPN-on-demand system: macOS menu bar app + AWS EC2 + Headscale/WireGuard.

## Project Vision

**What**: On-demand VPN that spins up when needed, tears down when idle
**Why**: Cost-effective, firewall-resistant VPN with native macOS UX
**How**: Menu bar app → Lambda starts EC2 → Headscale coordinates → WireGuard tunnel

## Architecture

### Components
1. **macOS Menu Bar App** (`SecretTunnel/`) - SwiftUI + NetworkExtension (NEPacketTunnelProvider)
2. **AWS Infrastructure** (`terraform/`) - EC2 + Lambda + API Gateway + CloudWatch
3. **VPN Layer** - Headscale control plane + WireGuard data plane
4. **Split Tunnel** - Home LAN (192.168.0.0/20) via NAS, internet via AWS

### Tech Stack
- **Client**: Swift/SwiftUI, XcodeGen, WireGuardKit
- **Infrastructure**: Terraform, AWS (EC2, Lambda, API Gateway, CloudWatch)
- **VPN**: Headscale (self-hosted Tailscale) + WireGuard
- **Build**: XcodeGen (project.yml) → Xcode project, `make build` / `make dmg`

## Quick Start

### Build the app
```bash
cd SecretTunnel
make build      # Build the app
make dmg        # Package as DMG
```

### Deploy infrastructure
```bash
./setup.sh      # Interactive setup (creates terraform.tfvars, deploys)
# OR manually:
cd terraform && terraform init && terraform apply
```

### Configure the app
1. Open Secret Tunnel from menu bar
2. Enter settings from `terraform output`:
   - API Endpoint
   - API Key (`terraform output -raw api_key`)
   - Headscale URL

## Project Structure

```
zeroteir/
├── SecretTunnel/              # macOS app
│   ├── Sources/SecretTunnel/  # App source code
│   │   ├── App/               # App entry point, delegate
│   │   ├── Views/             # SwiftUI views (MenuBar, Settings, Onboarding)
│   │   ├── Services/          # Business logic (Tunnel, Instance, Headscale)
│   │   ├── Models/            # Data models
│   │   └── Utilities/         # Constants, Logger
│   ├── SecretTunnelExtension/ # NetworkExtension (PacketTunnelProvider)
│   ├── Shared/                # IPC types shared between app and extension
│   ├── Resources/             # Entitlements, Info.plist, Assets
│   ├── LocalPackages/         # Vendored WireGuardKit
│   ├── Scripts/               # build-dmg.sh, setup-wireguardkit.sh
│   ├── project.yml            # XcodeGen config
│   ├── Makefile               # Build commands
│   └── Package.swift          # SPM package definition
├── terraform/                 # AWS infrastructure
│   ├── main.tf                # EC2, networking, security groups
│   ├── lambda.tf              # Lambda functions, API Gateway
│   ├── cloudwatch.tf          # Monitoring, alarms
│   ├── iam.tf                 # IAM roles, policies
│   ├── variables.tf           # Input variables
│   ├── outputs.tf             # Output values
│   └── files/                 # Cloud-init, Lambda code
├── releases/                  # Packaged DMG builds
├── setup.sh                   # One-command infrastructure deploy
└── CLAUDE.md                  # This file
```

## Build Details

- **Team ID**: 7552UR9ZVD
- **Bundle IDs**: `com.secrettunnel.vpn` (app), `com.secrettunnel.vpn.tunnel` (extension)
- **App Group**: `group.com.secrettunnel.vpn`
- **Signing**: Automatic, requires `-allowProvisioningUpdates DEVELOPMENT_TEAM=7552UR9ZVD`
- **WireGuardKit**: Vendored at `LocalPackages/wireguard-apple/`
- **libwg-go.a**: Pre-built for arm64 in `Sources/WireGuardKitGo/`
- **XcodeGen SPM bug**: Makefile auto-patches missing `package` back-reference

## AWS Infrastructure

- **Profile**: `zeroteir` (IAM user: zeroteir-terraform)
- **Region**: us-east-1
- **SSM paths**: `/secrettunnel/*`
- **CloudWatch namespace**: `SecretTunnel`

## Security Notes
- Credentials must never be committed (see `.gitignore`)
- AWS credentials via environment or AWS CLI config
- API keys stored in macOS Keychain
- Headscale API key auto-generated by cloud-init → SSM Parameter Store

## Repository

- Remote: Private Gitea instance (192.168.1.83:3000)
- Branch: main
